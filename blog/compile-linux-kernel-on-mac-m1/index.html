<!doctype html><html lang=id><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I just got my first Mac M1 machine, and this article show you step-by-step i do to compile linux kernel for my Raspberry Pi Zero W on my Mac M1 using Docker. "><link rel=canonical href=https://akhmad.id/blog/compile-linux-kernel-on-mac-m1/><title>Compile Linux Kernel on Mac M1 | Akhmad</title><link rel=stylesheet type=text/css href=https://akhmad.id/assets/css/tailwind.css><link rel=stylesheet type=text/css href="https://fonts.googleapis.com/css?family=Fira+Sans:400,700&display=swap"><link rel=stylesheet type=text/css href="https://fonts.googleapis.com/css?family=Fira+Code:400,700&display=swap"><link rel=icon type=image/ico href=https://akhmad.id/assets/favicon.ico><meta property="og:title" content="Compile Linux Kernel on Mac M1"><meta property="og:description" content="I just got my first Mac M1 machine, and this article show you step-by-step i do to compile linux kernel for my Raspberry Pi Zero W on my Mac M1 using Docker."><meta property="og:type" content="article"><meta property="og:url" content="https://akhmad.id/blog/compile-linux-kernel-on-mac-m1/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-06-05T18:08:40+07:00"><meta property="article:modified_time" content="2022-06-05T18:08:40+07:00"><meta property="og:site_name" content="Akhmad Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Compile Linux Kernel on Mac M1"><meta name=twitter:description content="I just got my first Mac M1 machine, and this article show you step-by-step i do to compile linux kernel for my Raspberry Pi Zero W on my Mac M1 using Docker."></head><body class="antialiased font-sans bg-white text-slate-900 dark:bg-slate-800 dark:text-white"><div class="relative min-h-screen"><div class=pb-10><nav id=nav__container class="mx-auto w-full px-4 md:px-6 py-2 md:py-3 flex flex-wrap items-center justify-between drop-shadow-xl bg-white dark:bg-slate-800"><div class="text-slate-800 dark:text-white mr-6 w-fit"><div class="flex flex-col"><a href=https://akhmad.id/ class="font-semibold text-xl hover:text-slate-700 dark:hover:text-slate-300">Akhmad</a>
<span class="text-xs sm:text-sm">Stories, Build logs, Ideas</span></div></div><div class="flex flex-row"><div class="flex flex-row self-start"><div class="mr-2 md:ml-2"><a class="font-semibold uppercase hover:text-slate-600 dark:hover:text-slate-300" href=../../now/ aria-label=Now>Now</a></div><div class=mx-2><a class="font-semibold uppercase hover:text-slate-600 dark:hover:text-slate-300" href=../../blog/ aria-label="Blog posts">Blog</a></div></div><div class="mx-3 lg:ml-8 self-end"><button id=dark_mode_toggle aria-label="Switch for Dark mode and Light mode"><svg class="text-slate-800 dark:text-white hover:text-slate-700 dark:hover:text-slate-300 fill-current h-6 w-6" id="btn_dark" viewBox="0 0 24 24"><path d="M14 2c1.82.0 3.53.5 5 1.35C16.01 5.08 14 8.3 14 12s2.01 6.92 5 8.65C17.53 21.5 15.82 22 14 22 8.48 22 4 17.52 4 12S8.48 2 14 2z"/></svg><svg class="text-slate-800 dark:text-white hover:text-slate-700 dark:hover:text-slate-300 fill-current h-6 w-6 hidden" id="btn_light" viewBox="0 0 24 24"><path d="M12 7c-2.76.0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55.0 1-.45 1-1s-.45-1-1-1H2c-.55.0-1 .45-1 1s.45 1 1 1zm18 0h2c.55.0 1-.45 1-1s-.45-1-1-1h-2c-.55.0-1 .45-1 1S19.45 13 20 13zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1S11 19.45 11 20zM5.99 4.58c-.39-.39-1.03-.39-1.41.0-.39.39-.39 1.03.0 1.41l1.06 1.06c.39.39 1.03.39 1.41.0s.39-1.03.0-1.41L5.99 4.58zM18.36 16.95c-.39-.39-1.03-.39-1.41.0-.39.39-.39 1.03.0 1.41l1.06 1.06c.39.39 1.03.39 1.41.0.39-.39.39-1.03.0-1.41l-1.06-1.06zM19.42 5.99c.39-.39.39-1.03.0-1.41-.39-.39-1.03-.39-1.41.0l-1.06 1.06c-.39.39-.39 1.03.0 1.41s1.03.39 1.41.0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03.0-1.41-.39-.39-1.03-.39-1.41.0l-1.06 1.06c-.39.39-.39 1.03.0 1.41s1.03.39 1.41.0l1.06-1.06z"/></svg></button></div></div></nav><main><header><div class="mt-6 md:mt-14 lg:mt-20"><div class="max-w-xl md:max-w-3xl xl:max-w-4xl mx-auto text-center px-6"><h1 class="text-3xl sm:text-5xl leading-tight font-sans font-bold mb-2 text-slate-800 dark:text-slate-100">Compile Linux Kernel on Mac M1</h1><p class="text-slate-700 dark:text-slate-200"><time datetime=2022-06-05 class="text-slate-900 dark:text-slate-100 text-xs mb-2 uppercase">Sunday, 5 June 2022</time></p></div></div></header><article class="max-w-xl md:max-w-2xl xl:max-w-4xl mx-auto px-6 sm:px-12 pt-12"><div class="prose lg:prose-lg dark:prose-invert max-w-xl md:max-w-2xl xl:max-w-4xl"><p>I just got my first Mac machine (it&rsquo;s cheapest Mac Mini M1), but it&rsquo;s really powerful machine, and i just got my Arducam 16MP Autofocus. So to see how powerful this mac is, and i need the latest kernel for my pi zero to use this cam, i&rsquo;m going to compile linux kernel on this Mac and see how much time it takes to compile the linux kernel on this machine. I have done that on my work laptop (i5-6300U; 16GB RAM) and it takes around 1 hours (not really sure the exact time, but it&rsquo;s around there).</p><p>So, the first thing we need is to setup this mac to compile the linux kernel, after some digging around, found <a href=https://www.raspberrypi.com/documentation/computers/linux_kernel.html#cross-compiling-the-kernel>this link about cross-compiling kernel</a>. I think most of the toolchains already installed with <code>xcode-select --install</code>, after installing xcode-select as usual, just need <code>arm-linux-gnueabihf-gcc</code> to be installed, but i can&rsquo;t find this package on brew, only got <code>arm-linux-gnueabihf-binutils</code>, so i try to install that one but the error is still there.</p><figure><a href=../../blog/compile-linux-kernel-on-mac-m1/img/error-arm-linux-gnueabihf.png><img loading=lazy srcset="https://akhmad.id/blog/compile-linux-kernel-on-mac-m1/img/error-arm-linux-gnueabihf_hu7adee67b2c1d9caa8f716fe4cec855d9_183400_320x0_resize_box_3.png 320w,
https://akhmad.id/blog/compile-linux-kernel-on-mac-m1/img/error-arm-linux-gnueabihf_hu7adee67b2c1d9caa8f716fe4cec855d9_183400_600x0_resize_box_3.png 600w,
https://akhmad.id/blog/compile-linux-kernel-on-mac-m1/img/error-arm-linux-gnueabihf.png 1200w" src=../../blog/compile-linux-kernel-on-mac-m1/img/error-arm-linux-gnueabihf_hu7adee67b2c1d9caa8f716fe4cec855d9_183400_600x0_resize_box_3.png alt></a></figure><p>After some digging around, found <a href=https://github.com/geerlingguy/raspberry-pi-pcie-devices/tree/master/extras/cross-compile>this tutorial from geerlingguy</a>, on his tutorial, he compile the kernel from debian buster with Docker, i guess this would work, just need to change the compile script since on his tutorial he&rsquo;s using arm64 raspi (while mine, still using arm 32bit). So, here we go</p><ol><li><p>Get the files from <a href=https://github.com/geerlingguy/raspberry-pi-pcie-devices/tree/master/extras/cross-compile>his repository</a> or you can find <a href=https://github.com/rockavoldy/linux-kernel-cross-compile>mine (with only essentials files) here</a>. If you have your SSH key, and want it to be passed to the container (for installing the kernel later directly to raspi), you can change <a href=https://github.com/rockavoldy/linux-kernel-cross-compile/blob/main/docker-compose.yml#L22>this line</a> to your ssh key.</p></li><li><p>After you&rsquo;re done cloning the files, you can create the container using docker-compose inside the repository, <code>docker compose up -d</code> is enough. It will download the OS images and setup the container for you with the toolchains needed.</p><figure><a href=../../blog/compile-linux-kernel-on-mac-m1/img/docker-compose-up.png><img loading=lazy srcset="https://akhmad.id/blog/compile-linux-kernel-on-mac-m1/img/docker-compose-up_hu164477f7972b6d8f0b85d071dee83c20_185353_320x0_resize_box_3.png 320w,
https://akhmad.id/blog/compile-linux-kernel-on-mac-m1/img/docker-compose-up_hu164477f7972b6d8f0b85d071dee83c20_185353_600x0_resize_box_3.png 600w,
https://akhmad.id/blog/compile-linux-kernel-on-mac-m1/img/docker-compose-up.png 1200w" src=../../blog/compile-linux-kernel-on-mac-m1/img/docker-compose-up_hu164477f7972b6d8f0b85d071dee83c20_185353_600x0_resize_box_3.png alt></a></figure></li><li><p>Then, you can use the container&rsquo;s terminal with <code>docker attach cross-compile</code>, to check if it&rsquo;s already inside, you can check with <code>uname -a</code> result.</p><figure><a href=../../blog/compile-linux-kernel-on-mac-m1/img/uname-result.png><img loading=lazy srcset="https://akhmad.id/blog/compile-linux-kernel-on-mac-m1/img/uname-result_hue3e8eb209e40439708d3fb7741b59cbc_20385_320x0_resize_box_3.png 320w,
https://akhmad.id/blog/compile-linux-kernel-on-mac-m1/img/uname-result_hue3e8eb209e40439708d3fb7741b59cbc_20385_600x0_resize_box_3.png 600w,
https://akhmad.id/blog/compile-linux-kernel-on-mac-m1/img/uname-result.png 1200w" src=../../blog/compile-linux-kernel-on-mac-m1/img/uname-result_hue3e8eb209e40439708d3fb7741b59cbc_20385_600x0_resize_box_3.png alt></a></figure></li><li><p>The build container is complete, you can clone the linux kernel repository now inside this container and do compile in here</p></li></ol><p>Basically, the <a href=https://github.com/rockavoldy/linux-kernel-cross-compile/blob/main/README.md#compile-kernel-for-raspi-zero-w>script to compile the kernel for Raspi Zero W</a> is</p><ol><li>Clone branch rpi-5.15.y with depth 1, since i just need the latest commit, so there is no point to get all history<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git clone https://github.com/raspberrypi/linux --branch rpi-5.15.y --depth <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>cd</span> linux
</span></span></code></pre></div></li><li>Create config for raspi 32bit<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>make -j4 <span style=color:#8be9fd;font-style:italic>ARCH</span><span style=color:#ff79c6>=</span>arm <span style=color:#8be9fd;font-style:italic>CROSS_COMPILE</span><span style=color:#ff79c6>=</span>arm-linux-gnueabihf- bcmrpi_defconfig
</span></span></code></pre></div><ol><li>(optional) If you want to change something in the kernel, maybe add, remove, or changes some kernel modules, you can use menuconfig.<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>make -j4 <span style=color:#8be9fd;font-style:italic>ARCH</span><span style=color:#ff79c6>=</span>arm <span style=color:#8be9fd;font-style:italic>CROSS_COMPILE</span><span style=color:#ff79c6>=</span>arm-linux-gnueabihf- menuconfig
</span></span></code></pre></div></li></ol></li><li>Compile the kernel with above configuration<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#6272a4># compile the kernel modules from configuration above</span>
</span></span><span style=display:flex><span>make -j4 <span style=color:#8be9fd;font-style:italic>ARCH</span><span style=color:#ff79c6>=</span>arm <span style=color:#8be9fd;font-style:italic>CROSS_COMPILE</span><span style=color:#ff79c6>=</span>arm-linux-gnueabihf- zImage modules dtbs
</span></span></code></pre></div></li></ol><p>When the compile process is done, you can install it directly to the raspi on the same network with</p><ol><li>Create new directory to hold raspi partition<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mkdir -p /mnt/pi-fat32
</span></span><span style=display:flex><span>mkdir -p /mnt/pi-ext4
</span></span></code></pre></div></li><li>Mount them with sshfs to above directory, make sure that pi is on the same network, and make sure again if the mounting is success by check with <code>ls</code> command<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sshfs root@raspberrypi.local:/ /mnt/pi-ext4
</span></span><span style=display:flex><span>sshfs root@raspberrypi.local:/boot /mnt/pi-fat32
</span></span><span style=display:flex><span>ls  -al /mnt/pi-ext4
</span></span><span style=display:flex><span>ls -al /mnt/pi-fat32
</span></span></code></pre></div></li><li>Copy kernel to the boot partition<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cp arch/arm/boot/zImage /mnt/pi-fat32/kernel7l.img
</span></span><span style=display:flex><span>cp arch/arm/boot/dts/*.dtb /mnt/pi-fat32/
</span></span><span style=display:flex><span>cp arch/arm/boot/dts/overlays/*.dtb* /mnt/pi-fat32/overlays/
</span></span><span style=display:flex><span>cp arch/arm/boot/dts/overlays/README /mnt/pi-fat32/overlays/
</span></span></code></pre></div></li><li>And install the modules to the root partition of raspi<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>env <span style=color:#8be9fd;font-style:italic>PATH</span><span style=color:#ff79c6>=</span><span style=color:#8be9fd;font-style:italic>$PATH</span> make -j4 <span style=color:#8be9fd;font-style:italic>ARCH</span><span style=color:#ff79c6>=</span>arm <span style=color:#8be9fd;font-style:italic>CROSS_COMPILE</span><span style=color:#ff79c6>=</span>arm-linux-gnueabihf- <span style=color:#8be9fd;font-style:italic>INSTALL_MOD_PATH</span><span style=color:#ff79c6>=</span>/mnt/pi-ext4 modules_install
</span></span></code></pre></div></li></ol><p>As you can see above, there is some difference with arm64 kernel from geerlingguy, it&rsquo;s <code>ARCH=arm</code>, <code>CROSS_COMPILE=arm-linux-gnueabihf-</code>, <code>zImage</code>, and <code>*.dtb</code> files, so make sure to check the target again.</p><p>For the result, on this Mac, i can compile the kernel in around 20 mins, can&rsquo;t really know the exact time, but it&rsquo;s much faster than i compile it on my work laptop.</p><p>I think that&rsquo;s it for now, it&rsquo;s been 2 weeks for me with this Mac, and it&rsquo;s a powerful machine for me. I&rsquo;m barely using all cores since my daily work is using python and Odoo, and it&rsquo;s actually run on my work laptop accessed with remote vscode and SSH from this Mac.</p><p>As for credit, Thanks to <a href=https://github.com/geerlingguy/raspberry-pi-pcie-devices/tree/master/extras/cross-compile>geerlingguy</a> to provide the docker files, and to create some articles and videos about linux and raspi.</p><p>PS:</p><blockquote><ul><li><a href=https://github.com/rockavoldy/linux-kernel-cross-compile>TL;DR version here</a></li><li>If you&rsquo;re wondering about the result of my arducam with raspi zero, you can <a href=https://gist.github.com/rockavoldy/ba13b728829af8426d7bc4b3e32ef0ef#about-raspicam>check it here</a></li><li>And sorry for my english, i want to make my english better, so from now on, i will post more articles in english.</li></ul></blockquote></div></article></main><br><br></div><div class="bottom-0 absolute w-full h-10 text-center"><footer class="text-slate-700 dark:text-slate-200 text-xs leading-normal flex flex-wrap justify-between mx-auto max-w-2xl px-4"><div class="w-full my-4"><p>Build with &#9829; in
<strong>Bandung</strong></p></div><div class="w-full sm:w-1/2"><nav><ul class="flex sm:justify-end -mx-2"></ul></nav></div></footer></div></div><script>const svgDark=document.getElementById("btn_dark"),svgLight=document.getElementById("btn_light"),btnDarkMode=document.getElementById("dark_mode_toggle");localStorage.theme==="dark"||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?(document.documentElement.classList.add("dark"),svgDark.classList.add("hidden"),svgLight.classList.remove("hidden"),localStorage.theme="dark"):(document.documentElement.classList.remove("dark"),svgLight.classList.add("hidden"),svgDark.classList.remove("hidden"),localStorage.theme="light"),btnDarkMode.onclick=function(){localStorage.theme==="dark"?(document.documentElement.classList.remove("dark"),svgLight.classList.add("hidden"),svgDark.classList.remove("hidden"),localStorage.theme="light"):(document.documentElement.classList.add("dark"),svgDark.classList.add("hidden"),svgLight.classList.remove("hidden"),localStorage.theme="dark")}</script><script async src=https://umami.akhmad.id/script.js data-website-id=5818ae25-1b72-473c-a58e-4f35e78ce30f></script></body></html>